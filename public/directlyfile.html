<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shubham Fancode Full-Screen Player</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        color: white;
        font-family: Arial, sans-serif;
      }

      #video-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      #video-player {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: black;
      }

      #live-button {
        position: absolute;
        bottom: 20px;
        padding: 10px 20px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.8;
      }

      #live-button:hover {
        opacity: 1;
      }

      #loading-message {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
      }
    </style>
  </head>
  <body>
    <div id="video-container">
      <div id="loading-message">Loading...</div>
      <video id="video-player"></video>
      <!-- Removed controls -->
      <button id="live-button">Go Live</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
      const video = document.getElementById("video-player");
      const liveButton = document.getElementById("live-button");
      const loadingMessage = document.getElementById("loading-message");

      // Check if the page is being loaded for the first time (to avoid continuous reload)
      if (localStorage.getItem("hasLoaded")) {
        window.location.reload(); // Prevent the page from being loaded again
      } else {
        localStorage.setItem("hasLoaded", "true");
      }

      // Extract the m3u8 URL directly from the query string
      const urlParams = new URLSearchParams(window.location.search);
      const m3u8Url = urlParams.get("url");

      // Get the match name from localStorage
      const matchName = localStorage.getItem("currentMatchName");

      // Set the page title to the match name if available
      if (matchName) {
        document.title = matchName;
      }

      // Play the HLS stream if the URL is provided
      if (m3u8Url) {
        playStream(m3u8Url);
      } else {
        alert("No match link provided.");
      }

      function playStream(url) {
        if (Hls.isSupported()) {
          const hls = new Hls({
            liveSyncDuration: 3,
            liveMaxLatencyDuration: 4,
            maxBufferLength: 20, // Allow more content to load ahead
            maxBufferSize: 2 * 1024 * 1024, // Larger buffer for smoother playback
            maxBufferHole: 1, // Tolerate a larger gap in the buffer
            lowLatencyMode: true, // Keep low latency mode for live streams
            backBufferLength: 30,
            highBufferWatchdogPeriod: 3, // Higher watchdog period
          });

          hls.loadSource(url);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            video.play();
            loadingMessage.style.display = "none"; // Hide loading message once the video starts
          });

          hls.on(Hls.Events.ERROR, function (event, data) {
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  alert("A network error occurred. Trying to recover...");
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  alert("A media error occurred. Attempting to recover...");
                  hls.recoverMediaError();
                  break;
                case Hls.ErrorTypes.OTHER_ERROR:
                  alert("An error occurred, trying to recover.");
                  hls.destroy();
                  break;
                default:
                  alert("An unexpected error occurred.");
                  hls.destroy();
              }
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = url;
          video.addEventListener("loadedmetadata", function () {
            video.play();
            loadingMessage.style.display = "none"; // Hide loading message once the video starts
          });
        } else {
          alert("HLS is not supported in this browser.");
        }
      }

      // Live button to jump to the live portion of the stream
      liveButton.addEventListener("click", function () {
        if (video) {
          video.currentTime = video.duration; // Jump to the live point
          video.play();
        }
      });

      // Prevent continuous reload by checking if the page has already loaded
      window.addEventListener("beforeunload", function () {
        localStorage.removeItem("hasLoaded"); // Reset after user leaves the page
      });
    </script>
  </body>
</html>
